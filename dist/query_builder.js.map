{"version":3,"sources":["../src/query_builder.js"],"names":["System","register","_export","_context","_","dfunc","buildQuery","target","adhocFilters","aggregation","metric","tags","functions","query","functionInstances","getFunctionInstances","length","join","adhocTags","buildAdHocFilterString","groups","split","i","as","groupedFuncs","groupBy","func","def","append","each","appends","render","wraps","map","f","createFuncInstance","funcDef","withDefaultParams","params","slice","filter","key","value","setters","_lodash","_dfunc","execute"],"mappings":"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","sourcesContent":["'use strict';\n\nSystem.register(['lodash', './dfunc'], function (_export, _context) {\n  \"use strict\";\n\n  var _, dfunc;\n\n  function buildQuery(target, adhocFilters) {\n    var aggregation = target.aggregation,\n        metric = target.metric,\n        tags = target.tags,\n        functions = target.functions;\n\n    var query = aggregation + ':' + metric;\n\n    var functionInstances = getFunctionInstances(functions);\n\n    if (tags && tags.length || adhocFilters && adhocFilters.length) {\n      query += '{';\n\n      if (tags && tags.length) {\n        query += tags.join(',');\n      }\n\n      if (adhocFilters && adhocFilters.length) {\n        var adhocTags = buildAdHocFilterString(adhocFilters);\n        if (tags && tags.length) {\n          query += ',';\n        }\n        query += adhocTags;\n      }\n\n      query += '}';\n    } else {\n      query += '{*}';\n    }\n\n    if (target.groups) {\n      let groups = target.groups.split(\",\");\n      query += ' by {';\n      for (let i = 0; i < groups.length; ++i) {\n        query += groups[i];\n        if (i !== groups.length - 1) {\n          query += ',';\n        }\n      }\n      query += '}';\n    }\n\n    if (target.as) {\n      query += '.' + target.as + '()';\n    }\n\n    var groupedFuncs = _.groupBy(functionInstances, function (func) {\n      if (func.def.append) {\n        return 'appends';\n      } else {\n        return 'wraps';\n      }\n    });\n\n    _.each(groupedFuncs.appends, function (func) {\n      query += '.' + func.render();\n    });\n\n    _.each(groupedFuncs.wraps, function (func) {\n      query = func.render(query);\n    });\n  \n    return query;\n  }\n\n  _export('buildQuery', buildQuery);\n\n  function getFunctionInstances(functions) {\n    return _.map(functions, function (func) {\n      var f = dfunc.createFuncInstance(func.funcDef, { withDefaultParams: false });\n      f.params = func.params.slice();\n      return f;\n    });\n  }\n\n  function buildAdHocFilterString(adhocFilters) {\n    return adhocFilters.map(function (filter) {\n      return filter.key + ':' + filter.value;\n    }).join(',');\n  }\n  return {\n    setters: [function (_lodash) {\n      _ = _lodash.default;\n    }, function (_dfunc) {\n      dfunc = _dfunc.default;\n    }],\n    execute: function () {}\n  };\n});\n//# sourceMappingURL=query_builder.js.map\n"],"file":"query_builder.js"}