{"version":3,"sources":["../../src/datasource.js"],"names":["queryBuilder","DataDogDatasource","instanceSettings","backendSrv","templateSrv","type","url","name","api_key","jsonData","application_key","app_key","supportMetrics","_cached_metrics","has_begun","invokeDataDogApiRequest","then","status","title","message","catch","error","console","log","getTagsFromCache","_","map","tags","hosts","tag","text","value","query","tagFindQuery","Promise","resolve","fetching","d","Date","setDate","getDate","from","Math","floor","getTime","getMetrics","metrics","metric","Object","keys","tagsHosts","kv","mapTagsToKVPairs","grafanaTags","test","options","grafanaValues","key","val","range","valueOf","to","targets","filter","t","hide","length","data","adhocFilters","getAdhocFilters","queries","target","rawQuery","buildQuery","queryString","join","replace","scopedVars","dataDogTagFormat","params","dataResponse","result","series","i","alias","expression","pointlist","point","timeFrom","timeTo","annotation","priority","sources","getEventStream","eventAnnotations","eventStreams","allEvents","eventStream","children","filteredEvents","event","alert_type","renderedText","isDataDogMarkdown","convertDataDogMdToHtml","time","date_happened","flatten","searchEntities","entity","q","results","getTags","_cached_tags","getTagsHosts","start","end","events","datasourceRequest","method","response","statusText","err","kv_tags","indexOf","kv_pairs","split","kv_object","forEach","pair","push","str","MD_START","MD_END","md_start_index","md_end_index","md","substring","removeImagesFromDataDogMarkdown","converter","showdown","Converter","makeHtml","dataDogImagePattern","isArray"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport showdown from './showdown.min.js';\nimport * as queryBuilder from './query_builder';\n\nexport class DataDogDatasource {\n\n  constructor (instanceSettings, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.api_key = instanceSettings.jsonData.api_key;\n    this.application_key = instanceSettings.jsonData.app_key;\n    this.supportMetrics = true;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this._cached_metrics = false;\n    this.has_begun = false;\n  }\n\n  // Function to check Datasource health\n  testDatasource() {\n    return this.invokeDataDogApiRequest('/downtime')\n    .then(() => {\n      return {\n        status: \"success\",\n        title: \"Success\",\n        message: \"Data source is working\"\n      };\n    })\n    .catch(error => {\n      var message = \"Connection error\";\n      if (error && error.message) {\n        message = error.message;\n      }\n\n      return {\n        status: \"error\",\n        title: \"Error\",\n        message: message\n      };\n    });\n  }\n\n  tagFindQuery() {\n    console.log(\"inside tagFindQuery()\");\n    return this.getTagsFromCache()\n    .then(tags => {\n      return _.map(tags, (hosts, tag) => {\n        return {\n          text: tag,\n          value: tag,\n        };\n      });\n    });\n  }\n\n  metricFindQuery(query) {\n    /* console.log(\"this.type: \" + this.type);\n    console.log(\"this.url: \" + this.url);\n    console.log(\"this.name: \" + this.name);\n    console.log(\"this.api_key: \" + this.api_key);\n    console.log(\"this.application_key: \" + this.application_key);\n    console.log(\"this.supportMetrics: \" + this.supportMetrics);\n    console.log(\"this.backendSrv: \" + this.backendSrv);\n    console.log(\"this.templateSrv: \" + this.templateSrv);\n    console.log(\"this._cached_metrics: \" + this._cached_metrics);\n    console.log(\"this.has_begun: \" + this.has_begun); */\n\n\n    console.log (\"inside metricFindQuery(). query: \" + query);\n\n    //console.log(\"query inside metricFindQuery: \" + query);\n    //console.log(\"newTEST::::::\" + this.fetching);\n\n   // var has_begun = false;\n    //export {has_begun};\n\n\n\n    /* if(this.has_begun === false) {\n      this.has_begun = true;\n\n      return 69;\n    } */\n\n   /*  if(this._cached_metrics != false) {\n      this.has_begun = false;\n      return 70;\n    } */\n    //console.log(\"this.has_begun:  \" + this.has_begun);\n\n    if(this.has_begun === true) {\n      if (query === 'tag') {\n        return this.tagFindQuery();\n      }\n\n      if (this._cached_metrics) {\n        return Promise.resolve(this._cached_metrics);\n      }\n\n      if (this.fetching) {\n        return this.fetching;\n      }\n      var d = new Date();\n      d.setDate(d.getDate() - 1);\n      var from = Math.floor(d.getTime() / 1000);\n      this.fetching = this.getMetrics(from).then(metrics => {\n        this._cached_metrics = _.map(metrics, metric => {\n          //console.log(\"this.fetching: \" +this.fetching[0]);\n          return {\n            text: metric,\n            value: metric,\n          };\n        });\n        //this._cached_metrics = this._cached_metrics.slice(0,10);\n        return this._cached_metrics;\n      });\n    }\n    return this.fetching;\n  }\n\n  getTagKeys() {\n    console.log(\"inside getTagKeys()\");\n    return this.getTagsFromCache()\n    .then(tagsHosts => {\n      let tags = Object.keys(tagsHosts);\n      let kv = mapTagsToKVPairs(tags);\n      let grafanaTags = Object.keys(kv);\n\n      return grafanaTags.map(tag => {\n        return {\n          text: tag,\n          value: tag,\n        };\n      });\n    });\n  }\n\n\n  getGroupBy() {\n    //var params = \"system.disk.directory.files\";\n    //var test = this.invokeDataDogApiRequest('/tags', params);\n    console.log(\"test:::::   \" + test);\n\n  }\n\n  getTagValues(options) {\n    console.log(\"inside getTagValues()\");\n    return this.getTagsFromCache()\n    .then(tagsHosts => {\n      let tags = Object.keys(tagsHosts);\n      let kv = mapTagsToKVPairs(tags);\n      let grafanaValues = kv[options.key];\n      return grafanaValues.map(val => {\n        return {\n          text: val,\n          value: val,\n        };\n      });\n    });\n  }\n\n  query(options) {\n    console.log(\"inside query()\");\n    var from = Math.floor(options.range.from.valueOf() / 1000);\n    var to = Math.floor(options.range.to.valueOf() / 1000);\n\n    var targets = options.targets.filter(function (t) { return !t.hide; });\n\n    if (targets.length <= 0) {\n      return Promise.resolve({data: []});\n    }\n\n    // add global adhoc filters\n    let adhocFilters = this.templateSrv.getAdhocFilters(this.name);\n\n    var queries = _.map(targets, target => {\n      let query;\n      if (target.rawQuery) {\n        query = target.query;\n      } else {\n        query = queryBuilder.buildQuery(target, adhocFilters);\n      }\n      return query;\n    });\n\n    var queryString = queries.join(',');\n    queryString = this.templateSrv.replace(queryString, options.scopedVars, dataDogTagFormat);\n\n    var params = {\n      from: from,\n      to: to,\n      query: queryString,\n    };\n\n    return this.invokeDataDogApiRequest('/query', params)\n    .then(result => {\n      var dataResponse = _.map(result.series, (series, i) => {\n        var target = targets[i];\n        return {\n          'target': target.alias || series.expression,\n          'datapoints': _.map(series.pointlist, point => {\n            return [point[1], point[0]];\n          })\n        };\n      });\n\n      return {data: dataResponse};\n    });\n  }\n\n  annotationQuery(options) {\n    console.log(\"annotationQuery\");\n    let timeFrom = Math.floor(options.range.from.valueOf() / 1000);\n    let timeTo = Math.floor(options.range.to.valueOf() / 1000);\n    let {priority, sources, tags} = options.annotation;\n\n    return this.getEventStream(timeFrom, timeTo, priority, sources, tags)\n    .then(eventStreams => {\n      let eventAnnotations = eventStreams.map(eventStream => {\n        let allEvents = eventStream.children;\n        let filteredEvents = _.filter(allEvents, event => {\n          return event.alert_type !== 'success';\n        });\n\n        return _.map(filteredEvents, event => {\n          let renderedText = eventStream.text;\n          if (isDataDogMarkdown(eventStream.text)) {\n            renderedText = convertDataDogMdToHtml(eventStream.text);\n          }\n\n          return {\n            annotation: options.annotation,\n            time: event.date_happened * 1000,\n            title: eventStream.title,\n            text: renderedText,\n            tags: eventStream.tags\n          };\n        });\n      });\n\n      return _.flatten(eventAnnotations);\n    });\n  }\n\n  getHosts() {\n    console.log(\"inside getHosts()\");\n    return this.searchEntities('hosts');\n  }\n\n  // entity should be 'hosts' or 'metrics'\n  // http://docs.datadoghq.com/api/?lang=console#search\n  searchEntities(entity) {\n    console.log(\"inside searchEntities()\");\n    let params = {q: ''};\n    if (entity) {\n      params.q = `${entity}:`;\n    }\n\n    return this.invokeDataDogApiRequest('/search', params)\n    .then(result => {\n      if (result && result.results) {\n        return result.results[entity];\n      }\n    });\n  }\n\n  getMetrics(timeFrom) {\n    console.log(\"inside getMetrics(timeFrom)\");\n    let params = {};\n\n    if (timeFrom) {\n      params.from = timeFrom;\n    }\n\n    return this.invokeDataDogApiRequest('/metrics', params)\n    .then(result => {\n      if (result.metrics) {\n        return result.metrics;\n      } else {\n        return [];\n      }\n    });\n  }\n\n  getTagsHosts() {\n    console.log(\"insideTagHosts\");\n    return this.invokeDataDogApiRequest('/tags/hosts')\n    .then(result => {\n      if (result && result.tags) {\n        return result.tags;\n      }\n    });\n  }\n\n  getTagsFromCache() {\n    console.log(\"inside getTagsFromCache\");\n    let getTags;\n    if (this._cached_tags && this._cached_tags.length) {\n      getTags = Promise.resolve(this._cached_tags);\n    } else {\n      getTags = this.getTagsHosts().then(tags => {\n        this._cached_tags = tags;\n        return tags;\n      });\n    }\n\n    return getTags;\n  }\n\n  getEventStream(timeFrom, timeTo, priority, sources, tags) {\n    console.log(\"inside getEventStream()\");\n    let params = {\n      start: timeFrom,\n      end: timeTo\n    };\n    if (priority) {\n      params.priority = priority;\n    }\n    if (sources) {\n      params.sources = sources;\n    }\n    if (tags) {\n      params.tags = tags;\n    }\n\n    return this.invokeDataDogApiRequest('/events', params)\n    .then(result => {\n      if (result.events) {\n        return result.events;\n      } else {\n        return [];\n      }\n    });\n  }\n\n  invokeDataDogApiRequest(url, params = {}) {\n    console.log(\"inside invokeDataDogApiRequest\");\n    // Set auth params\n    params.api_key = this.api_key;\n    params.application_key = this.application_key;\n\n    return this.backendSrv.datasourceRequest({\n      method: 'GET',\n      url: this.url + url,\n      params: params\n    })\n    .then(response => {\n      if (response.data) {\n        return response.data;\n      } else {\n        throw {message: 'DataDog API request error'};\n      }\n    })\n    .catch(error => {\n      var message = 'DataDog API request error';\n      if (error.statusText) {\n        message = error.status + ' ' + error.statusText;\n        throw {message: message};\n      } else if (error.err.statusText) {\n        throw {message: error.err.statusText};\n      } else {\n        throw {message: message};\n      }\n    });\n  }\n}\n\n/*\n * Convert tags to key-value pairs\n * [region:east, region:nw] => {region: [east, nw]}\n */\nfunction mapTagsToKVPairs(tags) {\n  console.log(\"inside mapTagsToKVPairs\");\n  let kv_tags = _.filter(tags, tag => {\n    return (tag.indexOf(':') !== -1);\n  });\n\n  let kv_pairs = kv_tags.map(tag => {\n    return tag.split(':', 2); // Limit to 2\n  });\n\n  let kv_object = {};\n  kv_pairs.forEach(pair => {\n    let key = pair[0];\n    let val = pair[1];\n\n    if (kv_object[key]) {\n      kv_object[key].push(val);\n    } else {\n      kv_object[key] = [val];\n    }\n  });\n\n  return kv_object;\n}\n\n/*\n * Convert DataDog event text from markdown to pure HTML\n * http://docs.datadoghq.com/guides/markdown/\n */\nfunction convertDataDogMdToHtml(str) {\n  console.log(\"inside convertDataDogMdToHtml\");\n  const MD_START = '%%%\\n';\n  const MD_END = '\\n%%%';\n\n  let md_start_index = str.indexOf(MD_START) + MD_START.length;\n  let md_end_index = str.indexOf(MD_END);\n  let md = str.substring(md_start_index, md_end_index);\n  md = removeImagesFromDataDogMarkdown(md);\n\n  let converter = new showdown.Converter();\n  return converter.makeHtml(md);\n}\n\nfunction isDataDogMarkdown(str) {\n  const MD_START = '%%%\\n';\n  return str.indexOf(MD_START) >= 0;\n}\n\nfunction removeImagesFromDataDogMarkdown(str) {\n  let dataDogImagePattern = /\\[{0,1}\\!\\[.*\\]\\(https{0,1}\\:\\/\\/p\\.datadoghq\\.com\\/snapshot.+\\)/g;\n  return str.replace(dataDogImagePattern, '');\n}\n\nfunction dataDogTagFormat(value) {\n  if (_.isArray(value)) {\n    return value.join(',');\n  }\n  return value;\n}\n"]}