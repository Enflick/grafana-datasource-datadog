{"version":3,"sources":["../../src/query_builder.js"],"names":["System","register","_export","_context","_","dfunc","buildQuery","target","adhocFilters","aggregation","metric","tags","functions","query","functionInstances","getFunctionInstances","length","join","adhocTags","buildAdHocFilterString","groups","split","i","as","groupedFuncs","groupBy","func","def","append","each","appends","render","wraps","map","f","createFuncInstance","funcDef","withDefaultParams","params","slice","filter","key","value","setters","_lodash","_dfunc","execute"],"mappings":"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","sourcesContent":["'use strict';\n\nSystem.register(['lodash', './dfunc'], function (_export, _context) {\n  \"use strict\";\n\n  var _, dfunc;\n\n  function buildQuery(target, adhocFilters) {\n    var aggregation = target.aggregation,\n        metric = target.metric,\n        tags = target.tags,\n        functions = target.functions;\n\n    var query = aggregation + ':' + metric;\n\n    var functionInstances = getFunctionInstances(functions);\n\n    if (tags && tags.length || adhocFilters && adhocFilters.length) {\n      query += '{';\n\n      if (tags && tags.length) {\n        query += tags.join(',');\n      }\n\n      if (adhocFilters && adhocFilters.length) {\n        var adhocTags = buildAdHocFilterString(adhocFilters);\n        if (tags && tags.length) {\n          query += ',';\n        }\n        query += adhocTags;\n      }\n\n      query += '}';\n    } else {\n      query += '{*}';\n    }\n\n    if (target.groups) {\n      let groups = target.groups.split(\",\");\n      query += ' by {';\n      for (let i = 0; i < groups.length; ++i) {\n        query += groups[i];\n        if (i !== groups.length - 1) {\n          query += ',';\n        }\n      }\n      query += '}';\n    }\n\n    if (target.as) {\n      query += '.' + target.as + '()';\n    }\n\n    var groupedFuncs = _.groupBy(functionInstances, function (func) {\n      if (func.def.append) {\n        return 'appends';\n      } else {\n        return 'wraps';\n      }\n    });\n\n    _.each(groupedFuncs.appends, function (func) {\n      query += '.' + func.render();\n    });\n\n    _.each(groupedFuncs.wraps, function (func) {\n      query = func.render(query);\n    });\n  \n    return query;\n  }\n\n  _export('buildQuery', buildQuery);\n\n  function getFunctionInstances(functions) {\n    return _.map(functions, function (func) {\n      var f = dfunc.createFuncInstance(func.funcDef, { withDefaultParams: false });\n      f.params = func.params.slice();\n      return f;\n    });\n  }\n\n  function buildAdHocFilterString(adhocFilters) {\n    return adhocFilters.map(function (filter) {\n      return filter.key + ':' + filter.value;\n    }).join(',');\n  }\n  return {\n    setters: [function (_lodash) {\n      _ = _lodash.default;\n    }, function (_dfunc) {\n      dfunc = _dfunc.default;\n    }],\n    execute: function () {}\n  };\n});\n//# sourceMappingURL=query_builder.js.map\n"],"file":"query_builder.js"}