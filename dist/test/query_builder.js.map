{"version":3,"sources":["../../src/query_builder.js"],"names":["buildQuery","target","adhocFilters","aggregation","metric","tags","functions","query","functionInstances","getFunctionInstances","length","join","adhocTags","buildAdHocFilterString","as","groupedFuncs","_","groupBy","func","def","append","each","appends","render","wraps","map","f","dfunc","createFuncInstance","funcDef","withDefaultParams","params","slice","filter","key","value"],"mappings":";;;;;QAGgBA,U,GAAAA,U;;AAHhB;;;;AACA;;;;;;AAEO,SAASA,UAAT,CAAoBC,MAApB,EAA4BC,YAA5B,EAA0C;AAAA,MAC1CC,WAD0C,GACFF,MADE,CAC1CE,WAD0C;AAAA,MAC7BC,MAD6B,GACFH,MADE,CAC7BG,MAD6B;AAAA,MACrBC,IADqB,GACFJ,MADE,CACrBI,IADqB;AAAA,MACfC,SADe,GACFL,MADE,CACfK,SADe;;AAE/C,MAAIC,QAAWJ,WAAX,SAA0BC,MAA9B;;AAEA,MAAII,oBAAqBC,qBAAqBH,SAArB,CAAzB;;AAEA,MAAKD,QAAQA,KAAKK,MAAd,IAA0BR,gBAAgBA,aAAaQ,MAA3D,EAAoE;AAClEH,aAAS,GAAT;;AAEA,QAAIF,QAAQA,KAAKK,MAAjB,EAAyB;AACvBH,eAASF,KAAKM,IAAL,CAAU,GAAV,CAAT;AACD;;AAED,QAAIT,gBAAgBA,aAAaQ,MAAjC,EAAyC;AACvC,UAAIE,YAAYC,uBAAuBX,YAAvB,CAAhB;AACA,UAAIG,QAAQA,KAAKK,MAAjB,EAAyB;AACvBH,iBAAS,GAAT;AACD;AACDA,eAASK,SAAT;AACD;;AAEDL,aAAS,GAAT;AACD,GAhBD,MAgBO;AACLA,aAAS,KAAT;AACD;;AAED,MAAIN,OAAOa,EAAX,EAAe;AACbP,aAAS,MAAMN,OAAOa,EAAb,GAAkB,IAA3B;AACD;;AAED,MAAIC,eAAeC,iBAAEC,OAAF,CAAUT,iBAAV,EAA6B,gBAAQ;AACtD,QAAIU,KAAKC,GAAL,CAASC,MAAb,EAAqB;AACnB,aAAO,SAAP;AACD,KAFD,MAEO;AACL,aAAO,OAAP;AACD;AACF,GANkB,CAAnB;;AAQAJ,mBAAEK,IAAF,CAAON,aAAaO,OAApB,EAA6B,gBAAQ;AACnCf,aAAS,MAAMW,KAAKK,MAAL,EAAf;AACD,GAFD;;AAIAP,mBAAEK,IAAF,CAAON,aAAaS,KAApB,EAA2B,gBAAQ;AACjCjB,YAAQW,KAAKK,MAAL,CAAYhB,KAAZ,CAAR;AACD,GAFD;;AAIA,SAAOA,KAAP;AACD;;AAED,SAASE,oBAAT,CAA8BH,SAA9B,EAAyC;AACvC,SAAOU,iBAAES,GAAF,CAAMnB,SAAN,EAAiB,gBAAQ;AAC9B,QAAIoB,IAAIC,gBAAMC,kBAAN,CAAyBV,KAAKW,OAA9B,EAAuC,EAACC,mBAAmB,KAApB,EAAvC,CAAR;AACAJ,MAAEK,MAAF,GAAWb,KAAKa,MAAL,CAAYC,KAAZ,EAAX;AACA,WAAON,CAAP;AACD,GAJM,CAAP;AAKD;;AAED,SAASb,sBAAT,CAAgCX,YAAhC,EAA8C;AAC5C,SAAOA,aAAauB,GAAb,CAAiB,kBAAU;AAChC,WAAOQ,OAAOC,GAAP,GAAa,GAAb,GAAmBD,OAAOE,KAAjC;AACD,GAFM,EAEJxB,IAFI,CAEC,GAFD,CAAP;AAGD","file":"query_builder.js","sourcesContent":["import _ from 'lodash';\nimport dfunc from './dfunc';\n\nexport function buildQuery(target, adhocFilters) {\n  let {aggregation, metric, tags, functions} = target;\n  let query = `${aggregation}:${metric}`;\n\n  let functionInstances  = getFunctionInstances(functions);\n\n  if ((tags && tags.length) || (adhocFilters && adhocFilters.length)) {\n    query += '{';\n\n    if (tags && tags.length) {\n      query += tags.join(',');\n    }\n\n    if (adhocFilters && adhocFilters.length) {\n      let adhocTags = buildAdHocFilterString(adhocFilters);\n      if (tags && tags.length) {\n        query += ',';\n      }\n      query += adhocTags;\n    }\n\n    query += '}';\n  } else {\n    query += '{*}';\n  }\n\n  if (target.as) {\n    query += '.' + target.as + '()';\n  }\n\n  var groupedFuncs = _.groupBy(functionInstances, func => {\n    if (func.def.append) {\n      return 'appends';\n    } else {\n      return 'wraps';\n    }\n  });\n\n  _.each(groupedFuncs.appends, func => {\n    query += '.' + func.render();\n  });\n\n  _.each(groupedFuncs.wraps, func => {\n    query = func.render(query);\n  });\n\n  return query;\n}\n\nfunction getFunctionInstances(functions) {\n  return _.map(functions, func => {\n    var f = dfunc.createFuncInstance(func.funcDef, {withDefaultParams: false});\n    f.params = func.params.slice();\n    return f;\n  });\n}\n\nfunction buildAdHocFilterString(adhocFilters) {\n  return adhocFilters.map(filter => {\n    return filter.key + ':' + filter.value;\n  }).join(',');\n}\n"]}