{"version":3,"sources":["../src/func_editor.js"],"names":["angular","_","$","module","directive","$compile","templateSrv","funcSpanTemplate","paramTemplate","funcControlsTemplate","restrict","link","postLink","$scope","elem","$funcLink","$funcControls","ctrl","func","funcDef","def","scheduledRelink","paramCountAtLink","clickFuncParam","paramIndex","$link","$input","next","val","params","css","width","hide","show","focus","select","typeahead","data","lookup","scheduledRelinkIfNeeded","length","setTimeout","relink","inputBlur","prev","newValue","optional","html","highlightVariablesAsHtml","updateParam","$apply","targetChanged","inputKeyPress","e","which","call","inputKeyDown","style","value","addTypeahead","attr","options","type","map","toString","source","minLength","items","updater","query","$element","process","toggleFuncControls","targetDiv","closest","hasClass","removeClass","addClass","addElementsAndCompile","appendTo","each","param","index","paramValue","$paramLink","blur","partial","keyup","keypress","click","contents","ifJustAddedFocusFistParam","added","find","first","registerFuncControlsToggle","registerFuncControlsActions","$target","target","removeFunction","move","functions","$index","window","open","children","remove"],"mappings":"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","sourcesContent":["import angular from 'angular';\nimport _ from 'lodash';\nimport $ from 'jquery';\n\n'use strict';\n\nangular\n  .module('grafana.directives')\n  .directive('datadogFuncEditor', function($compile, templateSrv) {\n\n    var funcSpanTemplate = '<a ng-click=\"\">{{func.def.name}}</a><span>(</span>';\n    var paramTemplate = '<input type=\"text\" style=\"display:none\"' +\n                        ' class=\"input-mini tight-form-func-param\"></input>';\n\n    var funcControlsTemplate =\n       '<div class=\"tight-form-func-controls\">' +\n         '<span class=\"pointer fa fa-arrow-left\"></span>' +\n         '<span class=\"pointer fa fa-question-circle\"></span>' +\n         '<span class=\"pointer fa fa-remove\" ></span>' +\n         '<span class=\"pointer fa fa-arrow-right\"></span>' +\n       '</div>';\n\n    return {\n      restrict: 'A',\n      link: function postLink($scope, elem) {\n        var $funcLink = $(funcSpanTemplate);\n        var $funcControls = $(funcControlsTemplate);\n        var ctrl = $scope.ctrl;\n        var func = $scope.func;\n        var funcDef = func.def;\n        var scheduledRelink = false;\n        var paramCountAtLink = 0;\n\n        function clickFuncParam(paramIndex) {\n          /*jshint validthis:true */\n\n          var $link = $(this);\n          var $input = $link.next();\n\n          $input.val(func.params[paramIndex]);\n          $input.css('width', ($link.width() + 16) + 'px');\n\n          $link.hide();\n          $input.show();\n          $input.focus();\n          $input.select();\n\n          var typeahead = $input.data('typeahead');\n          if (typeahead) {\n            $input.val('');\n            typeahead.lookup();\n          }\n        }\n\n        function scheduledRelinkIfNeeded() {\n          if (paramCountAtLink === func.params.length) {\n            return;\n          }\n\n          if (!scheduledRelink) {\n            scheduledRelink = true;\n            setTimeout(function() {\n              relink();\n              scheduledRelink = false;\n            }, 200);\n          }\n        }\n\n        function inputBlur(paramIndex) {\n          /*jshint validthis:true */\n          var $input = $(this);\n          var $link = $input.prev();\n          var newValue = $input.val();\n\n          if (newValue !== '' || func.def.params[paramIndex].optional) {\n            $link.html(templateSrv.highlightVariablesAsHtml(newValue));\n\n            func.updateParam($input.val(), paramIndex);\n            scheduledRelinkIfNeeded();\n\n            $scope.$apply(function() {\n              ctrl.targetChanged();\n            });\n\n            $input.hide();\n            $link.show();\n          }\n        }\n\n        function inputKeyPress(paramIndex, e) {\n          /*jshint validthis:true */\n          if(e.which === 13) {\n            inputBlur.call(this, paramIndex);\n          }\n        }\n\n        function inputKeyDown() {\n          /*jshint validthis:true */\n          this.style.width = (3 + this.value.length) * 8 + 'px';\n        }\n\n        function addTypeahead($input, paramIndex) {\n          $input.attr('data-provide', 'typeahead');\n\n          var options = funcDef.params[paramIndex].options;\n          if (funcDef.params[paramIndex].type === 'int') {\n            options = _.map(options, function(val) { return val.toString(); });\n          }\n\n          $input.typeahead({\n            source: options,\n            minLength: 0,\n            items: 20,\n            updater: function (value) {\n              setTimeout(function() {\n                inputBlur.call($input[0], paramIndex);\n              }, 0);\n              return value;\n            }\n          });\n\n          var typeahead = $input.data('typeahead');\n          typeahead.lookup = function () {\n            this.query = this.$element.val() || '';\n            return this.process(this.source);\n          };\n        }\n\n        function toggleFuncControls() {\n          var targetDiv = elem.closest('.tight-form');\n\n          if (elem.hasClass('show-function-controls')) {\n            elem.removeClass('show-function-controls');\n            targetDiv.removeClass('has-open-function');\n            $funcControls.hide();\n            return;\n          }\n\n          elem.addClass('show-function-controls');\n          targetDiv.addClass('has-open-function');\n\n          $funcControls.show();\n        }\n\n        function addElementsAndCompile() {\n          $funcControls.appendTo(elem);\n          $funcLink.appendTo(elem);\n\n          _.each(funcDef.params, function(param, index) {\n            if (param.optional && func.params.length <= index) {\n              return;\n            }\n\n            if (index > 0) {\n              $('<span>, </span>').appendTo(elem);\n            }\n\n            var paramValue = templateSrv.highlightVariablesAsHtml(func.params[index]);\n            var $paramLink = $('<a ng-click=\"\" class=\"datadog-func-param-link\">' + paramValue + '</a>');\n            var $input = $(paramTemplate);\n\n            paramCountAtLink++;\n\n            $paramLink.appendTo(elem);\n            $input.appendTo(elem);\n\n            $input.blur(_.partial(inputBlur, index));\n            $input.keyup(inputKeyDown);\n            $input.keypress(_.partial(inputKeyPress, index));\n            $paramLink.click(_.partial(clickFuncParam, index));\n\n            if (funcDef.params[index].options) {\n              addTypeahead($input, index);\n            }\n\n          });\n\n          $('<span>)</span>').appendTo(elem);\n\n          $compile(elem.contents())($scope);\n        }\n\n        function ifJustAddedFocusFistParam() {\n          if ($scope.func.added) {\n            $scope.func.added = false;\n            setTimeout(function() {\n              elem.find('.datadog-func-param-link').first().click();\n            }, 10);\n          }\n        }\n\n        function registerFuncControlsToggle() {\n          $funcLink.click(toggleFuncControls);\n        }\n\n        function registerFuncControlsActions() {\n          $funcControls.click(function(e) {\n            var $target = $(e.target);\n            if ($target.hasClass('fa-remove')) {\n              toggleFuncControls();\n              $scope.$apply(function() {\n                ctrl.removeFunction($scope.func);\n              });\n              return;\n            }\n\n            if ($target.hasClass('fa-arrow-left')) {\n              $scope.$apply(function() {\n                _.move(ctrl.functions, $scope.$index, $scope.$index - 1);\n                ctrl.targetChanged();\n              });\n              return;\n            }\n\n            if ($target.hasClass('fa-arrow-right')) {\n              $scope.$apply(function() {\n                _.move(ctrl.functions, $scope.$index, $scope.$index + 1);\n                ctrl.targetChanged();\n              });\n              return;\n            }\n\n            if ($target.hasClass('fa-question-circle')) {\n              window.open(\"http://docs.datadoghq.com/graphing/#apply-more-advanced-functions\", '_blank');\n              return;\n            }\n          });\n        }\n\n        function relink() {\n          elem.children().remove();\n\n          addElementsAndCompile();\n          ifJustAddedFocusFistParam();\n          registerFuncControlsToggle();\n          registerFuncControlsActions();\n        }\n\n        relink();\n      }\n    };\n\n  });\n"],"file":"func_editor.js"}