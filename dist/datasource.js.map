{"version":3,"sources":["../src/datasource.js"],"names":["_","DataDogDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","api_key","jsonData","application_key","app_key","supportMetrics","q","_cached_metrics","datasourceRequest","method","params","then","response","status","message","title","_cached_tags","when","fetching_tags","self","map","data","tags","hosts","tag","text","value","fetching","d","Date","setDate","getDate","from","Math","floor","getTime","metrics","metric","options","range","valueOf","to","targets","filter","t","hide","length","queries","val","query","queryString","join","dataResponse","series","i","target","alias","expression","pointlist","a"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\n\nexport class DataDogDatasource {\n\n  constructor (instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.api_key = instanceSettings.jsonData.api_key;\n    this.application_key = instanceSettings.jsonData.app_key;\n    this.supportMetrics = true;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this._cached_metrics = false;\n  }\n\n  // Function to check Datasource health\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/downtime',\n      method: 'GET',\n      params: {\n        api_key: this.api_key,\n        application_key: this.application_key,\n      }\n    }).then(function(response) {\n      if (response.status === 200) {\n        return {\n          status: \"success\",\n          message: \"Data source is working\",\n          title: \"Success\",\n        };\n      }\n    });\n  }\n\n  metricFindTags() {\n    if (this._cached_tags) {\n      return this.q.when(this._cached_tags);\n    }\n\n    if (this.fetching_tags) {\n      return this.fetching_tags;\n    }\n    var self = this;\n    this.fetching_tags = this.backendSrv.datasourceRequest({\n      url: self.url + '/tags/hosts',\n      method: 'GET',\n      params: {\n        api_key: self.api_key,\n        application_key: self.application_key,\n      }\n    }).then(function(response) {\n      self._cached_tags = _.map(response.data.tags, function (hosts, tag) {\n        return {\n          text: tag,\n          value: tag,\n        };\n      });\n\n      return self._cached_tags;\n    });\n\n    return this.fetching_tags;\n  }\n\n  metricFindQuery() {\n    if (this._cached_metrics) {\n      return this.q.when(this._cached_metrics);\n    }\n\n    if (this.fetching) {\n      return this.fetching;\n    }\n\n    var d = new Date();\n    d.setDate(d.getDate() - 1);\n    var from = Math.floor(d.getTime() / 1000);\n    var self = this;\n\n    this.fetching = this.backendSrv.datasourceRequest({\n      url: self.url + '/metrics',\n      method: 'GET',\n      params: {\n        api_key: self.api_key,\n        application_key: self.application_key,\n        from: from\n      }\n    }).then(function(response) {\n      self._cached_metrics = _.map(response.data.metrics, function (metric) {\n        return {\n          text: metric,\n          value: metric,\n        };\n      });\n\n      return self._cached_metrics;\n    });\n\n    return this.fetching;\n  }\n\n  query(options) {\n    var from = Math.floor(options.range.from.valueOf() / 1000);\n    var to = Math.floor(options.range.to.valueOf() / 1000);\n\n    var targets = options.targets.filter(function (t) { return !t.hide; });\n\n    if (targets.length <= 0) {\n      return this.q.when({data: []});\n    }\n    var queries = _.map(options.targets, function (val) {\n      return val.query;\n    });\n    var queryString = queries.join(',');\n    var query = {\n      api_key: this.api_key,\n      application_key: this.application_key,\n      from: from,\n      to: to,\n      query: queryString,\n    };\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/query',\n      params: query,\n      method: 'GET',\n    }).then(function (response) {\n\n      var dataResponse = _.map(response.data.series, function (series, i) {\n        var target = targets[i];\n        return {\n          'target': target.alias || series.expression,\n          'datapoints': _.map(series.pointlist, function (a) {\n            return [a[1], a[0]];\n          })\n        };\n      });\n\n      return {data: dataResponse};\n    });\n  }\n}\n"]}