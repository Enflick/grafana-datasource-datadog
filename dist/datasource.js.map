{"version":3,"sources":["../src/datasource.js"],"names":["System","register","_export","_context","_","showdown","queryBuilder","_createClass","DataDogDatasource","_classCallCheck","instance","Constructor","TypeError","mapTagsToKVPairs","tags","kv_tags","filter","tag","indexOf","kv_pairs","map","split","kv_object","forEach","pair","key","val","push","convertDataDogMdToHtml","str","MD_START","MD_END","md_start_index","length","md_end_index","md","substring","removeImagesFromDataDogMarkdown","converter","Converter","makeHtml","isDataDogMarkdown","dataDogImagePattern","replace","dataDogTagFormat","value","isArray","join","setters","_lodash","_showdownMinJs","_query_builder","execute","defineProperties","target","props","i","descriptor","enumerable","configurable","writable","Object","defineProperty","protoProps","staticProps","prototype","instanceSettings","backendSrv","templateSrv","type","url","name","api_key","jsonData","application_key","app_key","supportMetrics","_cached_metrics","testDatasource","invokeDataDogApiRequest","then","status","title","message","error","tagFindQuery","getTagsFromCache","hosts","text","metricFindQuery","query","_this","Promise","resolve","fetching","d","Date","setDate","getDate","from","Math","floor","getTime","getMetrics","metrics","metric","getTagKeys","tagsHosts","keys","kv","grafanaTags","getTagValues","options","grafanaValues","range","valueOf","to","targets","t","hide","data","adhocFilters","getAdhocFilters","queries","rawQuery","buildQuery","queryString","scopedVars","params","result","dataResponse","series","expression","pointlist","point","annotationQuery","timeFrom","timeTo","_options$annotation","annotation","priority","sources","getEventStream","eventStreams","eventAnnotations","eventStream","allEvents","children","filteredEvents","event","alert_type","renderedText","time","date_happened","flatten","getHosts","searchEntities","entity","q","results","getTagsHosts","_this2","getTags","_cached_tags","start","end","events","arguments","undefined","datasourceRequest","method","response","statusText","err"],"mappings":"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","sourcesContent":["'use strict';\n\nSystem.register(['lodash', './showdown.min.js', './query_builder'], function (_export, _context) {\n  \"use strict\";\n\n  var _, showdown, queryBuilder, _createClass, DataDogDatasource;\n\n  function _classCallCheck(instance, Constructor) {\n    if (!(instance instanceof Constructor)) {\n      throw new TypeError(\"Cannot call a class as a function\");\n    }\n  }\n\n  /*\n   * Convert tags to key-value pairs\n   * [region:east, region:nw] => {region: [east, nw]}\n   */\n  function mapTagsToKVPairs(tags) {\n    var kv_tags = _.filter(tags, function (tag) {\n      return tag.indexOf(':') !== -1;\n    });\n\n    var kv_pairs = kv_tags.map(function (tag) {\n      return tag.split(':', 2); // Limit to 2\n    });\n\n    var kv_object = {};\n    kv_pairs.forEach(function (pair) {\n      var key = pair[0];\n      var val = pair[1];\n\n      if (kv_object[key]) {\n        kv_object[key].push(val);\n      } else {\n        kv_object[key] = [val];\n      }\n    });\n\n    return kv_object;\n  }\n\n  /*\n   * Convert DataDog event text from markdown to pure HTML\n   * http://docs.datadoghq.com/guides/markdown/\n   */\n  function convertDataDogMdToHtml(str) {\n    var MD_START = '%%%\\n';\n    var MD_END = '\\n%%%';\n\n    var md_start_index = str.indexOf(MD_START) + MD_START.length;\n    var md_end_index = str.indexOf(MD_END);\n    var md = str.substring(md_start_index, md_end_index);\n    md = removeImagesFromDataDogMarkdown(md);\n\n    var converter = new showdown.Converter();\n    return converter.makeHtml(md);\n  }\n\n  function isDataDogMarkdown(str) {\n    var MD_START = '%%%\\n';\n    return str.indexOf(MD_START) >= 0;\n  }\n\n  function removeImagesFromDataDogMarkdown(str) {\n    var dataDogImagePattern = /\\[{0,1}\\!\\[.*\\]\\(https{0,1}\\:\\/\\/p\\.datadoghq\\.com\\/snapshot.+\\)/g;\n    return str.replace(dataDogImagePattern, '');\n  }\n\n  function dataDogTagFormat(value) {\n    if (_.isArray(value)) {\n      return value.join(',');\n    }\n    return value;\n  }\n  return {\n    setters: [function (_lodash) {\n      _ = _lodash.default;\n    }, function (_showdownMinJs) {\n      showdown = _showdownMinJs.default;\n    }, function (_query_builder) {\n      queryBuilder = _query_builder;\n    }],\n    execute: function () {\n      _createClass = function () {\n        function defineProperties(target, props) {\n          for (var i = 0; i < props.length; i++) {\n            var descriptor = props[i];\n            descriptor.enumerable = descriptor.enumerable || false;\n            descriptor.configurable = true;\n            if (\"value\" in descriptor) descriptor.writable = true;\n            Object.defineProperty(target, descriptor.key, descriptor);\n          }\n        }\n\n        return function (Constructor, protoProps, staticProps) {\n          if (protoProps) defineProperties(Constructor.prototype, protoProps);\n          if (staticProps) defineProperties(Constructor, staticProps);\n          return Constructor;\n        };\n      }();\n\n      _export('DataDogDatasource', DataDogDatasource = function () {\n        function DataDogDatasource(instanceSettings, backendSrv, templateSrv) {\n          _classCallCheck(this, DataDogDatasource);\n\n          this.type = instanceSettings.type;\n          this.url = instanceSettings.url;\n          this.name = instanceSettings.name;\n          this.api_key = instanceSettings.jsonData.api_key;\n          this.application_key = instanceSettings.jsonData.app_key;\n          this.supportMetrics = true;\n          this.backendSrv = backendSrv;\n          this.templateSrv = templateSrv;\n          this._cached_metrics = false;\n        }\n\n        // Function to check Datasource health\n\n\n        _createClass(DataDogDatasource, [{\n          key: 'testDatasource',\n          value: function testDatasource() {\n            return this.invokeDataDogApiRequest('/downtime').then(function () {\n              return {\n                status: \"success\",\n                title: \"Success\",\n                message: \"Data source is working\"\n              };\n            }).catch(function (error) {\n              var message = \"Connection error\";\n              if (error && error.message) {\n                message = error.message;\n              }\n\n              return {\n                status: \"error\",\n                title: \"Error\",\n                message: message\n              };\n            });\n          }\n        }, {\n          key: 'tagFindQuery',\n          value: function tagFindQuery() {\n            return this.getTagsFromCache().then(function (tags) {\n              return _.map(tags, function (hosts, tag) {\n                return {\n                  text: tag,\n                  value: tag\n                };\n              });\n            });\n          }\n        }, {\n          key: 'metricFindQuery',\n          value: function metricFindQuery(query) {\n            var _this = this;\n\n            if (query === 'tag') {\n              return this.tagFindQuery();\n            }\n\n            if (this._cached_metrics) {\n              return Promise.resolve(this._cached_metrics);\n            }\n\n            if (this.fetching) {\n              return this.fetching;\n            }\n\n            var d = new Date();\n            d.setDate(d.getDate() - 1);\n            var from = Math.floor(d.getTime() / 1000);\n\n            this.fetching = this.getMetrics(from).then(function (metrics) {\n              _this._cached_metrics = _.map(metrics, function (metric) {\n                return {\n                  text: metric,\n                  value: metric\n                };\n              });\n\n              return _this._cached_metrics;\n            });\n\n            return this.fetching;\n          }\n        }, {\n          key: 'getTagKeys',\n          value: function getTagKeys() {\n            return this.getTagsFromCache().then(function (tagsHosts) {\n              var tags = Object.keys(tagsHosts);\n              var kv = mapTagsToKVPairs(tags);\n              var grafanaTags = Object.keys(kv);\n\n              return grafanaTags.map(function (tag) {\n                return {\n                  text: tag,\n                  value: tag\n                };\n              });\n            });\n          }\n        }, {\n          key: 'getTagValues',\n          value: function getTagValues(options) {\n            return this.getTagsFromCache().then(function (tagsHosts) {\n              var tags = Object.keys(tagsHosts);\n              var kv = mapTagsToKVPairs(tags);\n              var grafanaValues = kv[options.key];\n              return grafanaValues.map(function (val) {\n                return {\n                  text: val,\n                  value: val\n                };\n              });\n            });\n          }\n        }, {\n          key: 'query',\n          value: function query(options) {\n            var from = Math.floor(options.range.from.valueOf() / 1000);\n            var to = Math.floor(options.range.to.valueOf() / 1000);\n\n            var targets = options.targets.filter(function (t) {\n              return !t.hide;\n            });\n\n            if (targets.length <= 0) {\n              return Promise.resolve({ data: [] });\n            }\n\n            // add global adhoc filters\n            var adhocFilters = this.templateSrv.getAdhocFilters(this.name);\n\n            var queries = _.map(targets, function (target) {\n              var query = void 0;\n              if (target.rawQuery) {\n                query = target.query;\n              } else {\n                query = queryBuilder.buildQuery(target, adhocFilters);\n              }\n              return query;\n            });\n\n            var queryString = queries.join(',');\n            queryString = this.templateSrv.replace(queryString, options.scopedVars, dataDogTagFormat);\n\n            var params = {\n              from: from,\n              to: to,\n              query: queryString\n            };\n\n            return this.invokeDataDogApiRequest('/query', params).then(function (result) {\n              var dataResponse = _.map(result.series, function (series, i) {\n                return {\n                  'target': series.expression,\n                  'datapoints': _.map(series.pointlist, function (point) {\n                    return [point[1], point[0]];\n                  })\n                };\n              });\n\n              return { data: dataResponse };\n            });\n          }\n        }, {\n          key: 'annotationQuery',\n          value: function annotationQuery(options) {\n            var timeFrom = Math.floor(options.range.from.valueOf() / 1000);\n            var timeTo = Math.floor(options.range.to.valueOf() / 1000);\n            var _options$annotation = options.annotation,\n                priority = _options$annotation.priority,\n                sources = _options$annotation.sources,\n                tags = _options$annotation.tags;\n\n\n            return this.getEventStream(timeFrom, timeTo, priority, sources, tags).then(function (eventStreams) {\n              var eventAnnotations = eventStreams.map(function (eventStream) {\n                var allEvents = eventStream.children;\n                var filteredEvents = _.filter(allEvents, function (event) {\n                  return event.alert_type !== 'success';\n                });\n\n                return _.map(filteredEvents, function (event) {\n                  var renderedText = eventStream.text;\n                  if (isDataDogMarkdown(eventStream.text)) {\n                    renderedText = convertDataDogMdToHtml(eventStream.text);\n                  }\n\n                  return {\n                    annotation: options.annotation,\n                    time: event.date_happened * 1000,\n                    title: eventStream.title,\n                    text: renderedText,\n                    tags: eventStream.tags\n                  };\n                });\n              });\n\n              return _.flatten(eventAnnotations);\n            });\n          }\n        }, {\n          key: 'getHosts',\n          value: function getHosts() {\n            return this.searchEntities('hosts');\n          }\n        }, {\n          key: 'searchEntities',\n          value: function searchEntities(entity) {\n            var params = { q: '' };\n            if (entity) {\n              params.q = entity + ':';\n            }\n\n            return this.invokeDataDogApiRequest('/search', params).then(function (result) {\n              if (result && result.results) {\n                return result.results[entity];\n              }\n            });\n          }\n        }, {\n          key: 'getMetrics',\n          value: function getMetrics(timeFrom) {\n            var params = {};\n\n            if (timeFrom) {\n              params.from = timeFrom;\n            }\n\n            return this.invokeDataDogApiRequest('/metrics', params).then(function (result) {\n              if (result.metrics) {\n                return result.metrics;\n              } else {\n                return [];\n              }\n            });\n          }\n        }, {\n          key: 'getTagsHosts',\n          value: function getTagsHosts() {\n            return this.invokeDataDogApiRequest('/tags/hosts').then(function (result) {\n              if (result && result.tags) {\n                return result.tags;\n              }\n            });\n          }\n        }, {\n          key: 'getTagsFromCache',\n          value: function getTagsFromCache() {\n            var _this2 = this;\n\n            var getTags = void 0;\n            if (this._cached_tags && this._cached_tags.length) {\n              getTags = Promise.resolve(this._cached_tags);\n            } else {\n              getTags = this.getTagsHosts().then(function (tags) {\n                _this2._cached_tags = tags;\n                return tags;\n              });\n            }\n\n            return getTags;\n          }\n        }, {\n          key: 'getEventStream',\n          value: function getEventStream(timeFrom, timeTo, priority, sources, tags) {\n            var params = {\n              start: timeFrom,\n              end: timeTo\n            };\n            if (priority) {\n              params.priority = priority;\n            }\n            if (sources) {\n              params.sources = sources;\n            }\n            if (tags) {\n              params.tags = tags;\n            }\n\n            return this.invokeDataDogApiRequest('/events', params).then(function (result) {\n              if (result.events) {\n                return result.events;\n              } else {\n                return [];\n              }\n            });\n          }\n        }, {\n          key: 'invokeDataDogApiRequest',\n          value: function invokeDataDogApiRequest(url) {\n            var params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n            // Set auth params\n            params.api_key = this.api_key;\n            params.application_key = this.application_key;\n\n            return this.backendSrv.datasourceRequest({\n              method: 'GET',\n              url: this.url + url,\n              params: params\n            }).then(function (response) {\n              if (response.data) {\n                return response.data;\n              } else {\n                throw { message: 'DataDog API request error' };\n              }\n            }).catch(function (error) {\n              var message = 'DataDog API request error';\n              if (error.statusText) {\n                message = error.status + ' ' + error.statusText;\n                throw { message: message };\n              } else if (error.err.statusText) {\n                throw { message: error.err.statusText };\n              } else {\n                throw { message: message };\n              }\n            });\n          }\n        }]);\n\n        return DataDogDatasource;\n      }());\n\n      _export('DataDogDatasource', DataDogDatasource);\n    }\n  };\n});\n//# sourceMappingURL=datasource.js.map\n"],"file":"datasource.js"}